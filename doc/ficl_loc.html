<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="john sadler">
    <meta name="description" content="Ficl local variables and syntax notes">
    <link rel="icon" href="ficl-icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="styles.css">
    <title>Ficl Local Variables</title>
  </head>
  <body>
    <header class="site-header">
      <div class="wrap">
        <a class="brand" href="index.html">
          <img class="brand-mark" src="ficl-icon.svg" alt="Ficl logo">
          <div>
            <span class="brand-name">Ficl</span>
            <span class="brand-tag">Forth Inspired Command Language</span>
          </div>
        </a>
        <nav class="site-nav">
          <a href="ficl.html">Docs</a>
          <a href="demo.html">Demo</a>
          <a href="ficl_rel.html">Release Notes</a>
          <a class="nav-cta" href="http://sourceforge.net/project/showfiles.php?group_id=24441">Download</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="page-hero">
        <div class="wrap">
          <p class="eyebrow">Language</p>
          <h1>Local Variables in Ficl</h1>
          <p>Local syntax, behavior, and usage examples.</p>
        </div>
      </section>

      <div class="wrap content">
        <table border="0" cellspacing="3" cols="1" width="675">
<tr>
<td>
<h2>
<a NAME="locals"></a>Local Variables</h2>
Named locally scoped variables came late to Forth. Purists feel that experienced
Forth programmers ought to write supportable code using only anonymous
stack variables and good factoring, but complain that novices use
global variables too much. Local variables cost little in terms of code
size and execution speed, and are very convenient for OO programming, where
stack effects are more complex. I use them a lot (maybe I'm a weenie).&nbsp;
<br><a href="http://www.taygeta.com/forth/dpans13.htm">Please refer to
the Standard</a> for more information on local variables.
<h2>
<a NAME="jhlocal"></a>Johns-Hopkins local variables</h2>
ANS Forth does not specify a complete and satisfying local variable facility.
Instead it defines a foundation upon which to build one. Ficl comes with
an adaptation of the Johns-Hopkins local variable syntax developed by John
Hayes et al. This is my preferred form, and I've extended it to make <a href="ficl_oop.html">OOP</a>
a bit simpler. Local variables can only be declared inside a definition,
and are only visible in that definition. Here's the syntax of a JH local
variable declaration:
<pre>
{ &lt;initialized-locals> | &lt;cleared-locals> -- &lt;ignored> }
</pre>
The declaration is designed to look like a stack comment, but it uses curly
braces instead of parens. The &lt;initialized-locals> names get their initial
values from the stack when the word executes. The &lt;cleared-locals> names
are (you guessed it) set to zero when the word executes, and any characters
between -- and } are treated as a comment. The | and -- sections are optional,
but they must appear in the order shown if they appear at all.&nbsp;
<br><b>Double cell locals </b>(AKA 2locals): ordinarily, each local represents
one cell. Local variable names prefixed with the characters "2:" in the declaration
are double-cell locals. The prefix is not part of the local variable's name, only
part of the declaration.
They behave the same as single cell locals in all
other respects. I use 2locals quite a bit in Ficl's OO classes, because
objects in Ficl require two cells on the stack.
<br><b>Float locals: </b>when Ficl is compiled with <code>FICL_WANT_FLOAT</code>,
local variable names prefixed with "f:" (or "F:") in the declaration are
float locals. Like the 2: prefix, the f: prefix is not part of the variable's
name. Float locals take their initial values from the float stack and push
to the float stack when referenced. A float local occupies one or two cells
in the locals frame depending on the size of <code>FICL_FLOAT</code> relative
to <code>CELL</code>.
<br>You can modify the
value of any local with <code><a href="http://www.taygeta.com/forth/dpans13.htm#13.6.1.2295">TO</a></code>.
<code>TO</code> determines whether it's operating on a <code>LOCAL</code>,
a <code>2LOCAL</code>, a float local, or a <code>VALUE</code>,
and does the right thing accordingly.
<br>Following are some examples to illustrate usage (they are not intended
to be good code otherwise). Try these out in the <A href="demo.html">demo</A> to get a feeling for
how they work. Also see <code>softwords/string.fr</code> for an example of use of locals
in OO code.
<pre>
: local-demo  { a b | c -- }
   ." a = " a . cr
   ." b = " b . cr
   ." c = " c . cr ;
1 2 local-demo  ( you should see 1 2 0 )

: my2dup  { 2:x }  x x ;  ( uses a 2local )
1 2 my2dup .s
.( you should see 1 2 1 2 on the stack ) cr empty

: my2swap  { 2:x 2:y -- y x }  y x ;  ( note use of 2locals )
1 2 3 4 my2swap .s
.( you should see 3 4 1 2 on the stack ) cr empty

: totally-lame-swap  { x y | temp -- y x }
   y to temp
   x to y
   temp to x
   x y ;

\ Using a float local (requires FICL_WANT_FLOAT)
: circle-area  { f:r -- f:area }
  r r f* 3.14159265e f* ;
</pre>
The last two definitions introduce the use of <code>TO</code> applied to local
variables.
<h2>Standard LOCALS and LOCALS EXT words</h2>
In addition to the Johns-Hopkins syntax, Ficl provides the standard
<code>LOCALS</code> and <code>LOCALS EXT</code> wordsets.
These produce the same compiled code as the JH syntax but only support
single-cell locals. The JH syntax adds support for <code>2LOCAL</code>s
and float locals.
<p>Ficl implements both local variable syntaxes
suggested in DPANS Appendix A.13. Examples:
<pre>
\ Using LOCALS| from LOCALS EXT
: -rot  ( a b c -- c a b )
  locals| c b a |
  c a b
;
</pre>

<pre>
\ Using LOCAL END-LOCAL
: -rot  ( a b c -- c a b )
   local c
   local b
   local a
   end-locals
   c a b
;
</pre>

<h2>Build Controls</h2>
<p>Local variable support is optional because it adds a small amount of overhead
to the outer interpreter. You can disable it by setting FICL_WANT_LOCALS
to 0 in sysdep.h or in your compiler flags.
</p>
<h3>Notes:</h3>
<bl>
  <li>
    Ficl's local variable syntax can make code quite a bit easier to read,
    so I encourage you to experiment with it.
  </li>
  <li>
    Locals or not, keep your words simple.
    If the stack twiddles are too complex, consider factoring the definition into
    smaller and simpler words.&nbsp;
  </li>
  <li>
    <a href="ficl_oop.html">Ficl's OOP</a> code makes heavy use of local variables,
    so if you enable FICL_WANT_OOP, locals will also be enabled automatically.
  </li>
  <li>
    The default maximum number of local variables per definition is 16. It's controlled
    by FICL_MAX_LOCALS in sysdep.h.&nbsp;
  </li>
</bl>

</td>
</tr>
        </table>
      </div>
    </main>

    <footer class="site-footer">
      <div class="wrap footer-grid">
        <div>Ficl - Forth Inspired Command Language</div>
        <div>Questions or contributions: <a href="https://sourceforge.net/u/jsadler/profile/">John Sadler</a></div>
      </div>
    </footer>
  </body>
</html>
